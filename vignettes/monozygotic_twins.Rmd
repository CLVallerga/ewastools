---
title: "Showcase: monozygotic twins"
author: "Jonathan Heiss"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extended QC: monozygotic twins}
  %\VignetteEngine{knitr::rmarkdown_notangle}
  \usepackage[utf8]{inputenc}
---

<style>
body{ font-size: 12pt; text-align: justify; }
p.caption {text-align: justify; font-style: italic; margin-left: 8mm;}
</style>


```{r, include = FALSE}
is_check <- ("CheckExEnv" %in% search()) || any(c("_R_CHECK_TIMINGS_",
             "_R_CHECK_LICENSE_") %in% names(Sys.getenv()))
knitr::opts_chunk$set(eval = !is_check)
```

```{r libraries, include=FALSE}
knitr::opts_chunk$set(fig.align="center")
```

```{r include=FALSE}
library(stringi)
library(data.table)
library(magrittr)
library(GEOmetadb)
library(ewastools)
```

*This vignette demonstrates the use of the ewastools package on a public available 450K dataset, with a focus on the implemented quality checks for identifying failed assays, mislabeled or contaminated samples. ewastools provides also functions for preprocessing (dye bias correction, normalization) and estimation of leukocyte composition.*

Download the GEOmetadb database and extract the metadata for the GSE61496 dataset. This dataset is comprised of 150 pairs of monozygotic twins (i.e. 300 samples + 10 technical replicates).

```{r}
getSQLiteFile(destdir="../data-raw")
con <- dbConnect(SQLite(), "../data-raw/GEOmetadb.sqlite")

samples = dbGetQuery(con, "SELECT gsm,series_id,supplementary_file,characteristics_ch1 FROM gsm
	WHERE gpl='GPL13534' AND series_id like 'GSE61496'")
setDT(samples)
dbDisconnect(con)
```

Extract the metadata (sex and ID of twin pairs). Remove the two samples without metadata.

```{r}
meta = stri_match(samples$characteristics_ch1,
	regex="2=f: ([12]);.*age: (\\d+);.*pair id: (\\d+)")
samples$sex = meta[,2] %>% factor(levels=c("1","2"),labels=c("m","f"))
samples$pair_id = as.numeric(meta[,4])
samples = samples[!is.na(sex)]
rm(meta)
```

Swap two samples on purpose.
```{r}
swap = samples[145]$supplementary_file
samples[145]$supplementary_file = samples[65]$supplementary_file
samples[65]$supplementary_file = swap
rm(swap)
```

Parse the .idat file names, create a new folder and download the dataset. Requires approx. 2.5GB of storage.
```{r}
files = stri_match(samples$supplementary_file,
	regex="^(ftp://ftp\\S*Grn\\.idat\\.gz);[:blank:](ftp://ftp\\S*Red\\.idat\\.gz)")
files = files[,2:3]

dir.create("../data-raw/GSE61496")
invisible(lapply(files,function(file) download.file(file,destfile=paste0("../data-raw/GSE61496/",basename(file)),quiet=TRUE) ))

files = basename(files)
files = stri_sub(files[1:310],1,-13)
samples$file = files
samples = samples[,list(gsm,pair_id,sex,file)]
```

Read in the dataset.
```{r}
raw = read_idats(paste0("../data-raw/GSE61496/",samples$file),quiet=TRUE)
```

The first check evaluates 17 control metrics. The "Bisulfite Conversion II" metric is exemplary plotted below. 3 samples fall below 1, which is the cut-off recommended by Illumina.
```{r fig.width=6,fig.height=3.5}
ctrls = control_metrics(raw)
stripchart(ctrls$`Bisulfite Conversion II`,method="jitter",pch=4,xlab='Bisulfite Conversion II')
abline(v=1,col=2,lty=3)
```

A logical vector of passed/failed is returned by `sample_failure()`. In this case, 26 samples were flagged. These samples warrant closer inspection (we'll skip this).
```{r}
sample_failure(ctrls) %>% table
```

Before the next check, dye bias is corrected and beta-values are computed. No normalization is performed.
```{r}
dye = correct_dye_bias(raw)
meth = dont_normalize(dye)
```

Sex check. The samples swapped above resulted in sex mismatches plotted in red. The actual sex of a sample donor can be inferred by calling `predict_sex()`.
```{r fig.width=6,fig.height=6}
XY = check_sex(dye)
samples$X = XY$X
samples$Y = XY$Y
rm(XY)

samples$predicted_sex = predict_sex(samples$X,samples$Y,which(samples$sex=='m'),which(samples$sex=='f'))

plot(X~Y,data=samples,pch=ifelse(samples$sex=="f",1,4),asp=1,xlab="Normalized X chromosome intensities",ylab="Normalized Y chromosome intensities")
points(X~Y,data=samples[sex!=predicted_sex],pch=ifelse(samples$sex=="f",1,3),col=2)
legend("topright",pch=c(1,4),legend=c("female","male"))
```

Genotype calling and classification of SNP outliers. First extract SNP probe positions from the manifest and use the matrix of beta-values as input for `call_genotypes`. This function estimates the parameters of a mixture model and returns posterior probabilities used as soft classification.
```{r}
snps = dye$manifest[probe_type=='rs',index]
snps = meth[snps,]

gt = call_genotypes(snps)
```

Use the classified SNPs to compare genetic fingerprints between samples. Monozygotic twins are in this check treated as one donor. List all conflicts, e.g. unexpected agreement or disagreement of fingerprints. The sample swap resulted in 8 conflicts: rows 1,4 and 5 indicate that sample #65 does not have the same fingerprint as #59, #303 and #309, even though they are supposed to come from the same donor. Analogously, row 6 indicates that sample #145 does not match the genetic fingerprint of sample #151. Rows 2,3,7 and 8 on the other hand shows the unexpected fingerprint matches between samples that are supposed to come from two different donors.
```{r}
check_snp_agreement(gt$gamma,1-gt$outliers,samples$pair_id,1:310)
```

The same data can be shown as a plot. The label "TRUE" corresponds to twin pairs, "FALSE" to non-twin pairs. There are eight (overlapping) outliers corresponding to the entries in the list above.

```{r fig.width=6, fig.height=4}
agreement_(gt$gamma,1-gt$outliers,samples$pair_id,1:310)
```

Check for outliers among the SNP probes. Such can indicate sample contamination or other technical problems. There are 7 samples that lie above our recommended cut-off.
```{r}
log_odds = snp_outliers(gt)
table(log_odds > -4)
```

Check if the 26 flagged samples perform worse on the outlier metric (the average log odds of being an outlier across the 65 SNP probes). Answer: they do, confirming that these samples warrant closer inspection.
```{r fig.width=6, fig.height=4}
boxplot( split(log_odds,sample_failure(ctrls)),horizontal=TRUE,xlab="Average log odds")
abline(v=-4,lty=3,col=2)
```

